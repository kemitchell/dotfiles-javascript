#!/bin/bash
set -e

if [ -z "$1" ] || [ -z "$2" ]; then
  echo "Usage: <remote> <clones directory>"
fi

remote="$1"
destination=$(realpath "$2")

mkdir -p "$destination"

TMP=$(mktemp -d)
trap cleanup EXIT
function cleanup () {
  rm -rf "$TMP"
}

git clone --quiet "$remote" "$TMP"
cd "$TMP"
npm install>/dev/null
npm ls --parseable --long | cut -d ":" -f 2 > deps
json dependencies < package.json | json -k -a > deps
json devDependencies < package.json | json -k -a > devDeps
cat deps devDeps | sort -u > allDeps
while read -r name; do
  npmclonerepo "$name" "$destination/$name" --bare
done < allDeps
